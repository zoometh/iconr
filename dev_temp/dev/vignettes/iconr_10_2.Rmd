---
title: "Graph and Spatial Analysis of Iconography for Prehistory"
author: "Thomas Huet"
email: "thomashuet7@gmail.com"
date: "`r format(Sys.Date())`"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Graph and Spatial Analysis of Iconography for Prehistory}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
references:
- id: Huet18
  title: Geometric graphs to study ceramic decoration
  author:
  - family: Huet
    given: Thomas
  container-title: Proceedings of the 44th Conference on Computer Applications and Quantitative Methods in Archaeology, CAA 2016
  publisher: Archaeopress
  page: 311-324
  type: article-journal
  URL: 'https://www.researchgate.net/publication/343514122_Geometric_graphs_to_study_ceramic_decoration'
  issued:
    year: 2018
    
- id: HuetAlexander15
  title: "Méthodes informatiques pour l’étude des gravures rupestres : les exemples du Valcamonica (Italie) et du mont Bego (France)"
  author:
  - name: "Thomas Huet"
  - name: "Craig Alexander"
  container-title: "Recherches sur l'âge du Bronze, Nouvelles approches et perspectives, Actes de la journée d'étude de l'Association pour la promotion des recherches archéologiques sur l'âge du Bronze, 28 février 2014, Saint-Germain-en-Laye"
  publisher: "Bulletin de l'APRAB, suppl. n° 1"
  page: 15-29
  type: article-journal
  issued:
    year: 2015

- id: Alexander08
  title: The Bedolina map -- an exploratory network analysis
  author:
  - name: "Craig Alexander"
  container-title: Layers of Perception. Proceedings of the 35th International Conference on Computer Applications and Quantitative Methods in Archaeology (CAA),  Berlin, 2.-6. April 2007
  publisher: Koll. Vor- u. Frühgesch
  page: 366-371
  type: article-journal
  doi: 'https://doi.org/10.11588/propylaeumdok.00000512'
  issued:
    year: 2008   

- id: DiazGuardamino10
  title: Las estelas decoradas en la Prehistoria de la Pen{\'\i}nsula Ib{\'e}rica
  author:
  - name: "Marta Diaz-Guardamino"
  publisher: Universidad Complutense de Madrid, Servicio de Publicaciones
  type: article-journal
  issued:
    year: 2010 
---

```{r, include = FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.pos = 'H'
)
```

# Introduction

The R package `decorr` is used to study iconography with network and spatial analysis indexes.  

Its purpose is to contribute to cross-cultural iconography comparisons studies by a higher normalization of quantitative analysis [@HuetAlexander15]. This package has been grounded on the seminal work of C. Alexander [@Alexander08] and its first IT implementation by T. Huet [@Huet18]. 

The main principle of `decorr` package is to considerate any iconographic composition (here, a 'decoration') as a geometric graph and to use analyses coming from Graph theory and GIS management.  

The package has been designed to accept shapefiles (.shp) for nodes and edges since a GIS interface is often the most practicale to record nodes and edges. Data input should mostly come from `POINTS`, and optionally `LINES`, overlapping all the graphical units of decoration recorded as a raster image.  

# Install

Install the `decorr` package from GitHub and load it.  

Other packages are required (`magick`) or suggested (`ggplot2`).

```{r load_decorr, warning=FALSE}
# devtools::install_github("zoometh/iconr")
library(decorr)
```

## Contents

The R package `decorr` is composed by functions and a dataset example (external data). All the drawings presented here have been first published by M. Diaz-Guardamino [@DiazGuardamino10]

### Functions

Functions are provided to manage nodes (`nds`), edges (`eds`) and graphs (`grph`).

```{r ls_functions}
cat(ls("package:decorr"),sep="\n")
```

### Data

External data attempt to give a training dataset to illustrate the format and procedures of the package.  

The current path of training external data is the `extdata` folder of the package. Change this working directory for your own directory.

```{r ls_ext_data}
cat(list.files(system.file("extdata", package = "decorr")),sep="\n")
```


Each decoration is a set of:

  + a drawing/image (.jpg)
  
  + a dataframe of decoration identifiers (.tsv)
  
  + a dataframe of nodes (.tsv or .shp)
  
  + a dataframe of edges (.tsv or .shp)
  

#### Drawings/Images

The decorations identifiers and paths to images are stored in the `imgs` dataframe

```{r imgs,fig.width=6, fig.height=6, fig.align="center",warning=FALSE, fig.cap="\\label{fig:figs}imgs.tsv"}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# read data
imgs <- read.table("imgs.tsv",sep="\t",stringsAsFactors = FALSE)
knitr::kable(imgs)
```


For example, the name of the `Cerrano Muriano 1` decoration is ``r imgs[1,"img"]``.  

Drawing/images (.jpg) are mostly managed with the R [`magick-image` package](https://cran.r-project.org/web/packages/magick/vignettes/intro.html)

```{r drawing,fig.width=6, fig.height=6, fig.align="center",warning=FALSE, fig.cap="\\label{fig:figs}Cerro_Muriano.Cerro_Muriano_1.jpg"}
library(magick)
setwd(system.file("extdata", package = "decorr"))
plot(image_read(a.img <- imgs[1,"img"]))
```


Nodes (ie, vertices) and edges inherit their coordinates from the decoration grid (ie, raster). Nodes are located approximatively on the centroid of graphical units. Two graphical units are connected with an edge when their Voronoi cell share a border (ie, neighbouring). The R [`igraph` package](https://igraph.org/r/) allow further network analysis. Other spatial analysis can be performed on a GIS.

#### Nodes

A dataframe (.tsv) or a shapefile (.shp) of the nodes. If the input data is the .tsv dataframe, column `x` and `y` are required


```{r nodes.df, warning=FALSE,fig.align="center",warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano", decor = "Cerro Muriano 1") 
knitr::kable(nds.df)
```


* column names  
  
  - `site`: decoration site 
  
  - `decor`: decoration name 
  
  - `id`: id of the edge (a unique number) 
    
  - `type`: type of the node    
    
  - `x,y`: coordinates of node  
    

#### Edges


A dataframe (.tsv) or a shapefile (.shp) of the edges If the input data is the .tsv dataframe, coordinates columns `xa` and `ya` (end of segment `a`), `xb` and `yb` (end of segment `b`), and are required

```{r edges.df, warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
eds.df <- read_nds(site = "Cerro Muriano", decor = "Cerro Muriano 1") 
knitr::kable(eds.df)
```
  
* column names  
  
  - `site`: decoration site 
  
  - `decor`: decoration name  
  
  - `id`: id of the edge (a unique number) 
    
  - `type`: type of the edge  
  
    - `=`: normal edge  
    
    - `+`: node `b` is an attribute of node `a` 
    
  - `a`: *id* of the first node  
    
  - `b`: *id* of the second node  
    
  - `xa, ya`: coordinates of the first node  (`a`) 
    
  - `xb, yb`: coordinates of the second node (`b`) 
  
##### Edges types

Commonly differents graphical units close one with another have the value `=` for their edge `type` and are displayed in <span style="color:orange">orange</span> and a plain line

```{r graph.attribute.plot.type, fig.width=6, fig.height=6, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
eds.df <- read_eds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Zarza de Montanchez",
                           decor = "Zarza De Montanchez",
                           lbl.txt = "type",
                           shw = c("nodes","edges"))
plot(img.graph)
```

When a graphical unit is an attribute of another, the edge is identified with a `+` and are displayed with a dashed line.  

For example, at the bottom of the `Zarza De Montanchez` decoration, one (1) main graphical unit, the chariot `7`, connected with four (4) attributes (or secondary graphical units):

  - two (2) horses `8` and `9`  
  
  - two (2) wheels `10` and `11` 
  

```{r img.graph.plot.a.edge, fig.width=6, fig.height=6, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
eds.df <- read_eds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Zarza de Montanchez",
                           decor = "Zarza De Montanchez",
                           lbl.txt = "id",
                           lbl.size = 2.2,
                           shw = c("nodes","edges"))
# one of the chariot edge
an.attribute.edge <- paste0(eds.df[8,"a"]," -",eds.df[8,"type"],"- ",eds.df[8,"b"])
cat(an.attribute.edge)
# the decoration
plot(img.graph)

```

## Examples

### Plot decoration graph

Plot `Cerro Muriano 1` nodes and edges for the field `type`

```{r img.graph.plot.type, fig.width=6, fig.height=6, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "type",
                           shw = c("nodes","edges"))
plot(img.graph)
```
  
Replot the graph with `id` field instead of the `type` field

```{r img.graph.plot.id, fig.width=6, fig.height=6, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "id",
                           shw = c("nodes","edges"))
plot(img.graph)
```
  
  
Replot the same graph with bigger and <span style="color:orange">orange</span> labels

```{r img.graph.plot.id.big, fig.width=6, fig.height=6, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "id",
                           lbl.color = "orange",
                           lbl.size=2,
                           shw = c("nodes","edges"))
plot(img.graph)
```

### Compare decoration graphs

Between all the graphs, or between a pair of graphs, nodes and edges can be compared with the functions `same_*` (all the graphs) and `plot_*_compar` (a pair of graphs), where `*` is replaced by `nds` for nodes or `eds` for edges.  
By default, between two decorations, common nodes and edges are in <span style="color:red">red</span>, but their colors -- and other graphical parameters -- can be modified.

#### Common Nodes

Count the common nodes between two decorations

```{r compare.nodes, warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# read data
imgs <- read.table("imgs.tsv",sep="\t",stringsAsFactors = FALSE)
nodes <- read.table("nodes.tsv",sep="\t",stringsAsFactors = FALSE)
edges <- read.table("edges.tsv",sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,"type") # call function
df.same_nodes <- same_nds(lgrph,"type")
knitr::kable(df.same_nodes,row.names = T)
```
  
  
The output is a symetrical dataframe where cells show the total number of common nodes by decorations (rows and columns headers).  

Here, we read that decorations `2` and `3` have five (5) common nodes. To show them, use the  `plot_nds_compar(listg,graph2)` function

```{r compare.2.nodes, out.width = "700px", fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# out.img path is only useful to open the output image
dec.to.compare <- c(2,3)
out.img <- paste0(getwd(),"/compar_nds_",dec.to.compare[1],"_",dec.to.compare[2],".png")
# read data
imgs <- read.table("imgs.tsv",sep="\t",stringsAsFactors = FALSE)
nodes <- read.table("nodes.tsv",sep="\t",stringsAsFactors = FALSE)
edges <- read.table("edges.tsv",sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,var="type")
g.compar <- list_nds_compar(lgrph, var="type")
plot_nds_compar(g.compar,dec.to.compare,var="type")
# open image
knitr::include_graphics(out.img) 
```

#### Common Edges

Count the common edges between two decorations

```{r compare.edges, warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# read data
imgs <- read.table("imgs.tsv",sep="\t",stringsAsFactors = FALSE)
nodes <- read.table("nodes.tsv",sep="\t",stringsAsFactors = FALSE)
edges <- read.table("edges.tsv",sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,"type") # call function
df.same_edges <- same_eds(lgrph,"type")
knitr::kable(df.same_edges,row.names = T)
```

The output is a symetrical dataframe showing the number of common edges. Here, we read that  decorations `2` and `3` have three (3) common edges. 

To show them, use the  `plot_eds_compar(listg,graph2)` function.

```{r compare.2.edges, out.width = "700px", fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# out.img path is only useful to open the output image
dec.to.compare <- c(2,3)
out.img <- paste0(getwd(),"/compar_eds_",dec.to.compare[1],"_",dec.to.compare[2],".png")
# read data
imgs <- read.table("imgs.tsv",sep="\t",stringsAsFactors = FALSE)
nodes <- read.table("nodes.tsv",sep="\t",stringsAsFactors = FALSE)
edges <- read.table("edges.tsv",sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,var="type")
g.compar <- list_eds_compar(lgrph,var="type")
plot_eds_compar(g.compar,dec.to.compare,"type")
# open image
knitr::include_graphics(out.img) 
```


# References


