---
title: "{decorr} Graph and Spatial Analysis of Iconography for Archaeology "
author: "Thomas Huet"
email: "thomashuet7@gmail.com"
date: "`r format(Sys.Date())`"
output: rmarkdown::html_vignette
bibliography: biblio9.bib
vignette: >
  %\VignetteIndexEntry{Graph and Spatial Analysis of Iconography for Archaeology}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(knitr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.pos = 'H'
)
```

# Introduction

The R package `decorr` is used to study iconography with network and spatial analysis indexes.  

This package has been grounded on the seminal work of C. Alexander [@Alexander08] and its first IT implementation by T. Huet [@Huet18a].  

Its purpose is to contribute to the normalization of quantitative analysis in ancient iconography studies [@HuetAlexander15]  

The main principle of `decorr` package is to considerate any iconographic composition (here, a 'decoration') as a geometric graph and to use analyses coming from Graph theory and GIS management.  

The package has been designed to accept shapefiles for nodes and edges since the GIS interface is the most practicale to record nodes and edges.  

All the drawings presented here for the `decorr` training dataset have been published by M. Diaz-Guardamino [@DiazGuardamino10]

# Install

Install the `decorr` package from GitHub and load it.  

Other packages are required (`magick`) or suggested (`ggplot2`).

```{r load_decorr, warning=FALSE}
# devtools::install_github("zoometh/iconr")
library(decorr)
# install.packages("magick")
# library(magick)
```

## Contents

The R package `decorr` is composed by functions and a dataset example (external data).

### Functions

Functions are provided to manage nodes (`nds`), edges (`eds`) and graphs (`grph`).

```{r ls_functions}
cat(ls("package:decorr"),sep="\n")
```

### External data

External data attempt to give a training dataset to illustrate the format and procedures of the package.  

The current path of training external data is the `extdata` folder of the package. Change this working directory for your own directory.

```{r ls_ext_data}
cat(list.files(system.file("extdata", package = "decorr")),sep="\n")
```


Each decoration is a set of:

  + a drawing/image (.jpg)
  
  + a dataframe of nodes (.tsv or .shp)
  
  + a dataframe of edges (.tsv or .shp)
  
The decorations identifiers and paths to images are stored in the `imgs` dataframe

```{r imgs,fig.width=7,fig.height=7, fig.align="center",warning=FALSE, fig.cap="\\label{fig:figs}imgs.tsv"}
# set wd to data folder
# setwd(system.file("extdata", package = "decorr"))
imgs.df <- read.table(system.file("extdata", "imgs.tsv", package = "decorr"),
                   sep="\t", stringsAsFactors = FALSE)
knitr::kable(imgs.df)
```


For example, the name of the `Cerrano Muriano 1` decoration is `r imgs.df[1,"img"]`

#### Drawings/Images

Load an image with the `magick` package

```{r drawing,fig.width=7,fig.height=7, fig.align="center",warning=FALSE, fig.cap="\\label{fig:figs}Cerro_Muriano.Cerro_Muriano_1.jpg"}
drawing <- magick::image_read(system.file("extdata",
                                          "Cerro_Muriano.Cerro_Muriano_1.jpg",
                                          package = "decorr"))
plot(drawing)
```

#### Nodes

A dataframe (.tsv) or a shapefile (.shp) of the nodes

```{r nodes.df, warning=FALSE,fig.align="center",warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano", decor = "Cerro Muriano 1") 
knitr::kable(nds.df)
```


* column names  
  
  - `site`: decoration site 
  
  - `decor`: decoration name 
  
  - `id`: id of the edge (a unique number) 
    
  - `type`: type of the node    
    
  - `x,y`: coordinates of node  
    

#### Edges


A dataframe (.tsv) or a shapefile (.shp) of the edges  

```{r edges.df, warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
eds.df <- read_nds(site = "Cerro Muriano", decor = "Cerro Muriano 1") 
knitr::kable(eds.df)
```
  
* column names  
  
  - `site`: decoration site 
  
  - `decor`: decoration name  
  
  - `id`: id of the edge (a unique number) 
    
  - `type`: type of the edge  
  
    - `=`: normal edge  
    
    - `+`: node `b` is an attribute of node `a` 
    
  - `a`: *id* of the first node  
    
  - `b`: *id* of the second node  
    
  - `xa, ya`: coordinates of the first node  (a) 
    
  - `xb, yb`: coordinates of the second node (b) 
  
##### Edges types

Commonly differents graphical units close one with another have the value `=` for their edge "type" and are displayed with a plain line.  

```{r graph.attribute.plot.type, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
eds.df <- read_eds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Zarza de Montanchez",
                           decor = "Zarza De Montanchez",
                           lbl.txt = "type",
                           shw = c("nodes","edges"))
plot(img.graph)
```

When a graphical unit is an attribute of another, the edge is identified with a `+` and are displayed with a dashed line. For example, the bottom of the `Zarza De Montanchez` decoration shows a chariot (main graphical unit) linked with two horses (attributes, or secondary graphical units) 

```{r img.graph.plot.a.edge, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
eds.df <- read_eds(site = "Zarza de Montanchez",decor = "Zarza De Montanchez")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Zarza de Montanchez",
                           decor = "Zarza De Montanchez",
                           lbl.txt = "id",
                           shw = c("nodes","edges"))
# one of the chariot edge
an.attribute.edge <- paste0(eds.df[8,"a"]," -",eds.df[8,"type"],"- ",eds.df[8,"b"])
cat(an.attribute.edge)
# the decoration
plot(img.graph)

```

## Examples

### Plot decoration graph

Plot "Cerro Muriano 1" nodes and edges for the field "type"

```{r img.graph.plot.type, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "type",
                           shw = c("nodes","edges"))
plot(img.graph)
```

The output `img.graph` is a magick-image

```{r img.graph}
class(img.graph)
```

Replot the graph with "id" field instead of "type" field

```{r img.graph.plot.id, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "id",
                           shw = c("nodes","edges"))
plot(img.graph)
```

Replot the same graph with bigger and orange labels

```{r img.graph.plot.id.big, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
setwd(system.file("extdata", package = "decorr"))
nds.df <- read_nds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
eds.df <- read_eds(site = "Cerro Muriano",decor = "Cerro Muriano 1")
img.graph <- plot_dec_grph(nds.df = nds.df,
                           eds.df = eds.df,
                           site = "Cerro Muriano",
                           decor = "Cerro Muriano 1",
                           lbl.txt = "id",
                           lbl.color = "orange",
                           lbl.size=2,
                           shw = c("nodes","edges"))
plot(img.graph)
```

### Compare decoration graphs

Between all the graphs, or between a pair of graphs, nodes and edges can be compared with the functions `same_*` (all the graphs) and `plot_*_compar` (a pair of graphs), where `*` is replaced by `nds` for nodes or `eds` for edges.

#### Nodes

Count the common nodes between two decorations

```{r compare.nodes, warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# read imgs, nodes and edges dataframes
imgs <- read.table(system.file("extdata", "imgs.tsv", package = "decorr"),
                   sep="\t",stringsAsFactors = FALSE)
nodes <- read.table(system.file("extdata", "nodes.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
edges <- read.table(system.file("extdata", "edges.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,"type") # call function
df.same_nodes <- same_nds(lgrph,"type")
knitr::kable(df.same_nodes,row.names = T)
```

The output is a symetrical dataframe showing the number of common nodes. Here, we read that  decorations `2` and `3` have five (5) common nodes. To show them, use the  `plot_nds_compar(listg,graph2)` function

```{r compare.2.nodes, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# out.img path is only useful to open the output image
dec.to.compare <- c(2,3)
out.img <- paste0(getwd(),"/compar_nds_",dec.to.compare[1],"_",dec.to.compare[2],".png")
# read data
imgs <- read.table(system.file("extdata", "imgs.tsv", package = "decorr"),
                   sep="\t",stringsAsFactors = FALSE)
nodes <- read.table(system.file("extdata", "nodes.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
edges <- read.table(system.file("extdata", "edges.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,var="type")
g.compar <- list_nds_compar(lgrph,var="type")
plot_nds_compar(g.compar,dec.to.compare)
# open image
knitr::include_graphics(out.img) 
```

Similarly to edges comparisons, by default the nodes *in common* are in \textcolor{red}{red}, but their colors, as the color of the nodes *different*

```{r compare.2.nodes.layout, out.width = "700px", fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# edges comparisons btw two graphs
g.compar <- list_nds_compar(lgrph,
                            var="type",
                            common.nds.color="blue",
                            different.nds.color="gray")
plot_nds_compar(g.compar,dec.to.compare)
# open image
knitr::include_graphics(out.img) 
```


#### Edges

Count the common edges between two decorations

```{r compare.edges, warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# read imgs, nodes and edges dataframes
imgs <- read.table(system.file("extdata", "imgs.tsv", package = "decorr"),
                   sep="\t",stringsAsFactors = FALSE)
nodes <- read.table(system.file("extdata", "nodes.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
edges <- read.table(system.file("extdata", "edges.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,"type") # call function
df.same_edges <- same_eds(lgrph,"type")
knitr::kable(df.same_edges,row.names = T)
```

The output is a symetrical dataframe showing the number of common edges. Here, we read that  decorations `2` and `3` have three (3) common edges. To show them, use the  `plot_eds_compar(listg,graph2)` function

```{r compare.2.edges, fig.width=7,fig.height=7, fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# out.img path is only useful to open the output image
dec.to.compare <- c(2,3)
out.img <- paste0(getwd(),"/compar_eds_",dec.to.compare[1],"_",dec.to.compare[2],".png")
# read data
imgs <- read.table(system.file("extdata", "imgs.tsv", package = "decorr"),
                   sep="\t",stringsAsFactors = FALSE)
nodes <- read.table(system.file("extdata", "nodes.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
edges <- read.table(system.file("extdata", "edges.tsv", package = "decorr"),
                    sep="\t",stringsAsFactors = FALSE)
lgrph <- list_dec(imgs,nodes,edges,var="type")
g.compar <- list_eds_compar(lgrph,var="type")
plot_eds_compar(g.compar,dec.to.compare)
# open image
knitr::include_graphics(out.img) 
```

By default the edges *in common* are in \textcolor{red}{red}, but their colors, as the color of the edges *different*

```{r compare.2.edges.layout, out.width = "700px", fig.align="center", warning=FALSE}
# set wd to data folder
setwd(system.file("extdata", package = "decorr"))
# edges comparisons btw two graphs
g.compar <- list_eds_compar(lgrph,
                            var="type",
                            common.eds.color="blue",
                            different.eds.color="gray")
plot_eds_compar(g.compar,dec.to.compare)
# open image
knitr::include_graphics(out.img) 
```


# References


